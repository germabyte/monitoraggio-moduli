<!DOCTYPE html>
<html lang="it">
<head>
    <!-- ... head content ... -->
    <title>Monitoraggio Moduli</title>
    <!-- ... CSS links and styles ... -->
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Monitoraggio Moduli</h1>

        <!-- API Key Input -->
        <div id="mainApp">
            <div class="mb-3">
                <label for="apiKey" class="form-label">Chiave API JotForm:</label>
                <input type="password" class="form-control" id="apiKey" placeholder="Inserisci la tua Chiave API JotForm" readonly>
                <div class="form-text">La tua chiave API viene utilizzata per accedere ai tuoi moduli e invii JotForm.</div>
            </div>

            <!-- Buttons -->
            <div class="mb-3 d-grid gap-2 d-md-flex justify-content-md-start">
                <button class="btn btn-primary me-md-2" id="retrieveFormsBtn">Recupera Moduli</button>
                <button class="btn btn-danger" id="deleteSubmissionsBtn">Elimina Invii Selezionati</button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-3">
                <label for="refreshProgress" class="form-label">Prossimo aggiornamento tra:</label>
                <div class="progress">
                    <div id="refreshProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="60"></div>
                </div>
                <small id="refreshCountdown" class="form-text text-muted">60 secondi</small>
            </div>

            <!-- Forms Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered align-middle" id="formsTable">
                    <thead>
                        <tr>
                            <th data-column="select" class="text-center" style="width: 60px;">Seleziona</th>
                            <th data-column="title">Titolo <span class="sort-arrow"></span></th>
                            <th data-column="id" style="width: 150px;">ID <span class="sort-arrow"></span></th>
                            <th data-column="status" style="width: 100px;">Stato <span class="sort-arrow"></span></th>
                            <th data-column="submissions" class="text-end" style="width: 80px;">Invii <span class="sort-arrow"></span></th>
                            <th data-column="lastSubmission" class="text-end" style="width: 180px;">Ultimo Invio <span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic Content -->
                    </tbody>
                </table>
            </div>

            <!-- Log Box -->
            <div class="mt-4">
                <h5>Registro:</h5>
                <div id="logBox"></div>
            </div>
        </div>
    </div>

    <!-- Password Authentication Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="authModalLabel">Autenticazione Necessaria</h5>
          </div>
          <div class="modal-body">
            <form id="authForm">
                <div class="mb-3">
                    <label for="userPassword" class="form-label">Inserisci la tua Password:</label>
                    <input type="password" class="form-control" id="userPassword" placeholder="Password" required>
                </div>
                <div id="authError" class="text-danger mb-3" style="display: none;">
                    Password non autorizzata.
                </div>
                <button type="submit" class="btn btn-primary">Invia</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JavaScript -->
    <script>
        // JotForm API base URL for EU accounts
        const BASE_URL = 'https://eu-api.jotform.com';

        // Global variables to track sort state
        let currentSortColumn = null;
        let currentSortOrder = 'asc';

        // Global variable for the authentication modal instance
        let authModalInstance;

        // Progress Bar Variables
        const refreshInterval = 60;
        let timeLeft = refreshInterval;
        let progressBarTimer;

        // Global variable to keep track of selected forms
        let selectedFormIds = new Set();

        // Store form data to compare during refresh
        let formDataMap = new Map();

        // Global variable to store allowedFormId for restricted users, null for unrestricted
        let allowedFormId = null;

        // Event Listeners
        document.getElementById('retrieveFormsBtn').addEventListener('click', () => {
            retrieveForms();
        });
        document.getElementById('deleteSubmissionsBtn').addEventListener('click', deleteSelectedSubmissions);
        document.querySelectorAll('#formsTable th').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-column');
                if (column && column !== 'select') {
                    sortTable(column);
                }
            });
        });

        // Function to log messages with timestamps
        function logMessage(message) {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleString();
            logBox.innerHTML += `<div><strong>${timestamp}:</strong> ${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        // Function to retrieve all forms (modified to handle form restriction)
        async function retrieveForms() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Per favore inserisci la tua Chiave API JotForm.');
                return;
            }

            logMessage('Recupero dei moduli...');
            try {
                // Add counts=true to get submission counts
                const response = await fetch(`${BASE_URL}/user/forms?apiKey=${apiKey}&counts=true`);
                if (!response.ok) {
                    throw new Error(`Errore HTTP! Stato: ${response.status}`);
                }
                const data = await response.json();

                if (!data.content) {
                    logMessage('Struttura di risposta inaspettata durante il recupero dei moduli.');
                    return;
                }

                let forms = data.content;

                // Filter forms if allowedFormId is set
                if (allowedFormId) {
                    forms = forms.filter(form => form.id === allowedFormId);
                    if (forms.length === 0) {
                        logMessage(`Nessun modulo trovato con ID ${allowedFormId}.`);
                        updateTable(new Map()); // Clear table if no form found
                        return;
                    } else {
                        logMessage(`Utente ristretto al modulo ID ${allowedFormId}.`);
                    }
                }

                // Map to store new form data
                const newFormDataMap = new Map();

                // Process each form
                for (let [index, form] of forms.entries()) {
                    const formTitle = form.title || 'Senza Titolo';
                    const formId = form.id || 'N/A';
                    const formStatus = form.status || 'ATTIVATO';
                    const isActive = formStatus.toUpperCase() === 'ENABLED' || formStatus.toUpperCase() === 'ATTIVATO';

                    // Get submission count from form data
                    const submissionCount = form.count || 0;

                    logMessage(`Modulo ${index + 1}/${forms.length}: '${formTitle}' (ID: ${formId}) ha ${submissionCount} invii`);
                    const lastSubmissionDate = await getLastSubmissionDate(formId, apiKey);

                    // Store form data
                    newFormDataMap.set(formId, {
                        formTitle,
                        formId,
                        formStatus,
                        isActive,
                        submissionCount,
                        lastSubmissionDate
                    });
                }

                // Update the table with new data
                updateTable(newFormDataMap);

                // Update the formDataMap with new data
                formDataMap = newFormDataMap;

                logMessage(`Recuperati ${forms.length} moduli.`);

                // Apply the current sort after refreshing the table
                if (currentSortColumn) {
                    applyCurrentSort();
                    updateSortArrows();
                } else {
                    updateSortArrows();
                }

                // Disable "Retrieve Forms" button for restricted users
                if (allowedFormId) {
                    document.getElementById('retrieveFormsBtn').disabled = true;
                }

            } catch (error) {
                logMessage(`Errore nel recupero dei moduli: ${error.message}`);
                console.error(error);
            } finally {
                resetProgressBarTimer();
            }
        }


        // Function to get last submission date for a form (no changes)
		async function getLastSubmissionDate(formId, apiKey) {
            // ... (same as before) ...
        }

		// Helper function to determine if a date is in Daylight Saving Time in ET (no changes)
		function isDaylightSavingTimeInET(date) {
            // ... (same as before) ...
		}


        // Function to update the table with new form data (no significant changes)
        function updateTable(newFormDataMap) {
            // ... (same as before, but ensure checkbox disabling logic remains) ...
             newFormDataMap.forEach((formData, formId) => {
                // ... existing logic ...
                    // Modified line: Disable checkbox if submissionCount is 0 OR if it's NOT the allowed form for restricted users
                    checkbox.disabled = formData.submissionCount === 0 || (allowedFormId && formId !== allowedFormId);
                // ... rest of the logic ...
            });
        }

        // Function to delete selected submissions (modified to check form restriction)
        async function deleteSelectedSubmissions() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Per favore inserisci la tua Chiave API JotForm.');
                return;
            }

            const checkboxes = document.querySelectorAll('.form-select-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Per favore seleziona almeno un modulo con invii per eliminare gli invii.');
                return;
            }

            // Check form restriction before deletion
            if (allowedFormId) {
                for (let checkbox of checkboxes) {
                    const formId = checkbox.getAttribute('data-form-id');
                    if (formId !== allowedFormId) {
                        alert(`Accesso negato. Puoi eliminare invii solo per il modulo ID ${allowedFormId}.`);
                        return;
                    }
                }
            }

            if (!confirm(`Sei sicuro di voler eliminare gli invii per ${checkboxes.length} modulo/i? Questa azione non puÃ² essere annullata.`)) {
                return;
            }

            for (let checkbox of checkboxes) {
                const formId = checkbox.getAttribute('data-form-id');
                const formTitle = checkbox.closest('tr').children[1].innerText;
                logMessage(`Eliminazione degli invii per il modulo: ${formTitle} (ID: ${formId})`);
                await deleteAllSubmissions(formId, apiKey);
                // Update the table row (same as before)
                const row = checkbox.closest('tr');
                row.children[4].innerText = '0';
                row.children[5].innerText = 'N/A';
                checkbox.checked = false;
                checkbox.disabled = true;
                selectedFormIds.delete(formId);

                // Update formDataMap (same as before)
                if (formDataMap.has(formId)) {
                    const formData = formDataMap.get(formId);
                    formData.submissionCount = 0;
                    formData.lastSubmissionDate = 'N/A';
                }
            }

            alert('Processo di eliminazione completato. Controlla il registro per i dettagli.');
            logMessage('Processo di eliminazione completato.');
        }

        // Function to delete all submissions for a form (no changes)
        async function deleteAllSubmissions(formId, apiKey) {
            // ... (same as before) ...
        }

        // Sorting functions (no changes)
        function sortTable(column) { /* ... */ }
        function getColumnIndex(column) { /* ... */ }
        function applyCurrentSort() { /* ... */ }
        function updateSortArrows() { /* ... */ }

        // Password Authentication Logic (modified to handle allowedFormId)
        document.getElementById('authForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const userPassword = document.getElementById('userPassword').value.trim();
            const authError = document.getElementById('authError');
            authError.style.display = 'none';

            if (!userPassword) {
                authError.textContent = 'Per favore inserisci una password valida.';
                authError.style.display = 'block';
                return;
            }

            try {
                // Fetch the whitelist.txt file
                const response = await fetch('whitelist.txt');
                if (!response.ok) {
                    throw new Error(`Impossibile recuperare la whitelist. Stato: ${response.status}`);
                }

                const whitelistData = await response.text();
                const lines = whitelistData.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                let authenticatedUserEntry = null;

                for (const line of lines) {
                    const parts = line.split(',');
                    if (parts.length >= 2) { // Ensure at least password and apikey are present
                        const encodedPassword = parts[0];
                        const encodedApiKey = parts[1];
                        const password = atob(encodedPassword);
                        const apiKey = atob(encodedApiKey);
                        let currentAllowedFormId = null; // default unrestricted

                        if (parts.length >= 3) {
                            currentAllowedFormId = parts[2].trim(); // Get the third value as allowedFormId
                        }

                        if (password === userPassword) {
                            authenticatedUserEntry = { apiKey: apiKey, allowedFormId: currentAllowedFormId };
                            break; // Stop searching after finding a match
                        }
                    }
                }


                if (authenticatedUserEntry) {
                    // Authentication successful
                    authModalInstance.hide();
                    document.getElementById('mainApp').style.display = 'block';
                    logMessage(`Utente autenticato con successo.`);

                    // Set global API Key and allowedFormId
                    document.getElementById('apiKey').value = authenticatedUserEntry.apiKey;
                    allowedFormId = authenticatedUserEntry.allowedFormId;

                    if (allowedFormId) {
                        logMessage(`Utente ristretto al modulo ID: ${allowedFormId}`);
                        document.getElementById('retrieveFormsBtn').disabled = true; // Disable retrieve button for restricted users
                    } else {
                        logMessage('Utente con accesso a tutti i moduli.');
                        document.getElementById('retrieveFormsBtn').disabled = false; // Enable retrieve button for unrestricted users
                    }


                    // Retrieve forms after authentication
                    retrieveForms();
                } else {
                    // Show error message
                    authError.textContent = 'Password non autorizzata.';
                    authError.style.display = 'block';
                    logMessage(`Tentativo di accesso non autorizzato.`);
                }
            } catch (error) {
                authError.textContent = `Errore durante l'autenticazione: ${error.message}`;
                authError.style.display = 'block';
                logMessage(`Errore durante l'autenticazione: ${error.message}`);
                console.error(error);
            }
        });

        // Progress Bar Functions (no changes)
        document.addEventListener('DOMContentLoaded', function() { /* ... */ });
        function updateProgressBar() { /* ... */ }
        function startProgressBarTimer() { /* ... */ }
        function resetProgressBarTimer() { /* ... */ }
    </script>
</body>
</html>
